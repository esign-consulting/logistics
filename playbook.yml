---
- hosts: "{{ target | default('default') }}"

  roles:
    - role: codeyourinfra.docker_compose
      become: true

  tasks:
    - name: Install required packages
      apt:
        name: "{{ item }}"
        update_cache: yes
      loop:
        - language-pack-pt
        - python3-pip
      become: true

    - name: Install required python packages
      pip:
        name: "{{ item }}"
      loop:
        - docker
        - docker-compose
      become: true

    - name: Build the Logistics application locally (requires Maven)
      shell: mvn clean install
      delegate_to: localhost

    - name: Copy required files
      copy:
        src: "{{ item }}"
        dest: .
      loop:
        - logistics-ear
        - standalone.xml
        - Dockerfile
        - docker-compose.yml

    - name: Build the Logistics Docker image
      docker_image:
        name: esignbr/logistics
        path: .
      become: true

    - name: Set up the Docker services
      docker_service:
        project_name: logistics
        project_src: .
      become: true
